# 内置执行器

内置执行器用于[关系配置](relation.md)中，相对来讲内置执行器是非常通用的，内置于 Natrue 中以方便大家的使用。

随着 Nature 应用领域的不断发觉，内置执行器会不断进行丰富和完善，因此此文档可能会经常调整。

此文档将以字母顺序罗列这些组件。

## scatter

**作用**：将关系中的上游数据拆分成多条下游数据。并用 `Instance.para` 来区分这些下游数据

**上游数据要求**：`Instance.content` 的内容必须为下面的 json 形式， **提示**：数据格式如果不满足要求，可以使用关系定义中的 `filter_before` 来进行修正。

```json
[
  {
    "key": "a/1",
    "value": 33
  },
  {
    "key": "a/2",
    "value": 76
  },
  ...
]
```

**下游数据说明**：上游数据中的 key 所对应的值会成为下游数据的 `Instance.para`， 而 value 所对应的值则会被放入下游数据的 content 中。其在 instance 数据表的体现形式示例如下：

| ins_key                | content |
| ---------------------- | ------- |
| B:downstream:1\|0\|a/1 | 33      |
| B:downstream:1\|0\|a/2 | 76      |

**选项**：

| 选项                | 说明                                                         | 缺省值 |
| ------------------- | ------------------------------------------------------------ | ------ |
| dimension_separator | 如果上游数据中的 key 对应的值不是用 para 的分隔符进行分隔的，且想转换为 para 的分隔符以利于后续对 para 进行处理，则需要设置此属性。 如 key 对应的值是 “a-1”， 则此属性应设置为 “-”。 | /      |

## sum

**作用**：将上游 `instance.content` 的值与下游的上一个版本 `instance.content` 中的 total 值相加，并将两者的和放到新版本的 total 中。

**示例**：

上游数据

| ins_key            | content |
| ------------------ | ------- |
| B:upstream:1\|0\|b | 76      |

下游的上一版本数据，其中 detail 中的 “a” 和 33 分别来源于上一次上游数据的 `instance.para` 和 `instance.content`. 

| ins_key           | content                        |
| ----------------- | ------------------------------ |
| B:upstream:1\|0\| | {"detail":{"a":37},"total":33} |

新生成的下游数据，其中 detail 中的 “b” 和 76 分别来源于本次上游数据的 `instance.para` 和 `instance.content`. 
| ins_key           | content                                  |
| ----------------- | ---------------------------------------- |
| B:upstream:1\|0\| | {"detail":{"a":37, "b":76}, "total":109} |

**结果说明**：detail 是所有的求和项，total 是所有 detail 中各项的和。detail 中的 key 可以通过 key_from_para 选项进行设置。

**模式**：sum 在求和过程中对 detail 中相同 key 的处理有很多模式，模式可以通过 when_same 选项进行说明。

| 模式        | 说明                         |
| ----------- | ---------------------------- |
| “” \| "old" | remain the old value         |
| "new"       | 只保留新值                   |
| "sum"       | 将新值和旧值相加             |
| "min"       | 只保留新值和旧值中小的那一个 |
| "max"       | 只保留新值和旧值中大的那一个 |

**选项**：

| 选项          | 说明                                                         | 示例  | 缺省值 |
| ------------- | ------------------------------------------------------------ | ----- | ------ |
| key_from_para | 从上游 instance.para 中按顺序选取一部分数据作为 detail.key。**剩下的将构成下游 instance.para** | [1,0] | []     |
| when_same     | sum 在求和过程中对相同 detail.key 的处理模式                 | “old” | “”     |

**使用建议**：不适合对拥有大量不同 `detail.key` 的数据进行求和，因为每次求和都会生成一个版本数据，会形成大量的 IO。